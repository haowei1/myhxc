<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <title>年度养护计划</title>
    <link rel="stylesheet" type="text/css" href="public/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="https://www.layui.com/admin/std/dist/layuiadmin/style/admin.css">
    <link href="public/css/common.css" type="text/css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="public/css/nav.css">
    <link rel="stylesheet" type="text/css" href="public/css/iconfont.css">
    <script src="public/js/jquery-3.2.1.min.js"></script>
    <script src="public/layui/layui.js"></script>
    <script src="public/js/common.js"></script>
    <script src="public/js/yhxc.js"></script>
</head>
<body>
<div class="main_height main_index lt" style="background: #f2f4f8;">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>年度养护计划</legend>
    </fieldset>
    <div class="layui-form layui-card-header layuiadmin-card-header-auto p20">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label" style="width: auto;">年份</label>
                <div class="layui-input-block" style="margin-left:100px">
                    <input type="text" id="searchKey" name="searchKey" placeholder="请输入" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <button class="layui-btn" data-type="reload"><i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>搜索</button>
                </button>
            </div>
        </div>
    </div>
    <div class="layui-row layui-col-space10" style="padding: 10px; background: #fff;">
        <div class="layui-btn-group demoTable">
            <button class="layui-btn" data-type="addData"><i class="layui-icon">&#xe608;</i>添加年度养护计划</button>
        </div>
        <div class="layui-btn-group demoTable">
            <button class="layui-btn" id="exportData" data-type="exportDatas"><i class="layui-icon">&#xe61a;</i>导出年度养护计划</button>
        </div>
        <div class="layui-btn-group demoTable m0">
            <button class="layui-btn layui-btn-danger" data-type="delData"><i class="layui-icon">&#xe640;</i>批量删除</button>
        </div>
        <div class="layui-btn-group demoTable">
            <button type="button" class="layui-btn layui-btn-primary" id="fileupload"><i class="layui-icon"></i>批量上传计划</button>
        </div>
        <button type="button" id="btn2">form方法下载</button>
        <table class="layui-hide" id="dataTable" lay-filter="dataFilter"></table>

        <script type="text/html" id="userBar">
            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit">修改</a>
            <a class="layui-btn layui-btn-danger layui-btn-xs ml5" lay-event="del">删除</a>
        </script>
    </div>
</div>
<script>
    xsui.setLeftMenu();
    xsui.setHeader();
</script>
<script type="text/javascript" src="public/js/nav.js"></script>
<script>
    $(document).ready(function (e) {
        var $eleBtn2 = $("#btn2");
        $eleBtn2.click(function(){
            var $eleForm = $("<form method='get'></form>");

            $eleForm.attr("action","./b0001/download");

            $(document.body).append($eleForm);

            $eleForm.submit();
        });
        /*function exportFile(){
            var form=$("<form>");
            form.attr("style","display:none");
            form.attr("target","");
            form.attr("method","post");//提交方式为post
            form.attr("action","/downloadFile");//定义action

            $("body").append(form);
            form.submit();
        }*/

    layui.use(['table','upload','layer','laydate'],function () {
        var laydate = layui.laydate //日期
            ,layer = layui.layer //弹层
            ,table = layui.table //表格
            ,upload = layui.upload //上传
            ,$=layui.$
        table.render({
            elem: '#dataTable'
            ,url: '/b0001/getAll' //数据接口
            ,title: '年养护计划表'
            /*,toolbar: 'true'*/
            ,page: true //开启分页
            ,cols: [[ //表头
                {type: 'checkbox', fixed: 'left'}
                ,{type: 'numbers', title: '序号', width:40,fixed: 'left'}
                ,{field: 'planYear', title: '计划年份', width:120}
                ,{field: 'roadId', title: '路线ID', width:120}
                ,{field: 'roadName', title: '路线名称', width:120}
                ,{field: 'mileageRangeId', title: '桩号区间', width:120}
                ,{field: 'facilityArea', title: '公路设施面积', width:120}
                ,{field: 'planmtcarea', title: '计划维修面积', width:120}
                ,{fixed: 'right', width: 165, align:'center', toolbar: '#userBar'}
            ]]
            ,id: 'dataTable'
        });

        upload.render({
            elem: '#fileupload',
            url: '/b0001/read/excel?random='+Math.random(),
            accept: 'file',
            exts: 'xls|xlsx',
            done: function (req) {
                active.reload();
            }
        });
        //监听行工具事件
        table.on('tool(dataFilter)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
            var data = obj.data //获得当前行数据
                ,layEvent = obj.event; //获得 lay-event 对应的值
            if(layEvent === 'edit'){
                layer.open({
                    type: 2,
                    shade: 0.8,
                    shadeClose: true,
                    title: '添加年养护计划',
                    area: ['500px','500px'],
                    content: './B000102.html?uuid='+data.uuid+'&random='+Math.random()
                })
            } else if(layEvent === 'del'){
                layer.confirm('真的删除行么', function(index){
                    obj.del(); //删除对应行（tr）的DOM结构
                    layer.close(index);
                    $.ajax({
                        type: 'post',
                        url: '/b0001/deleteAData',
                        data: {
                            'uuid':obj.data.uuid
                        },
                        success: function (response) {
                            if (response.code!=0){
                                layer.alert(response.msg);
                            } else {
                                active.reload();
                            }
                        }
                    })
                });
            }
        });

        $('#exportData').on('click',function () {
            $.ajax({
                type: 'GET',
                url: '/b0001/exportData',
                success: function (response) {
                    layer.alert("导出成功")
                },
                error: function (e) {
                    layer.alert('系统发生错误');
                }
            })
        })
        var active={
            reload: function () {
                table.reload('dataTable',{
                    where: {
                        form: {
                            planYear: $('#searchKey').val()
                        }
                    },
                    page: {
                        curr: 1
                    }
                })
            },
            addData: function () {
               layer.open({
                   type: 2,
                   shade: 0.8,
                   shadeClose: true,
                   title: '添加年养护计划',
                   area: ['500px','500px'],
                   content: './B000102.html'
               })
            },
            delData: function (datas) {
                var checkStatus = table.checkStatus('dataTable')
                    ,data = checkStatus.data; //获取选中的数据
                console.log(data)
                if (data.length === 0){
                    layer.alert("没有选中数据");
                }else {
                    var array=new Array();
                    $.each(data,function (i,record) {
                        array.push(record.uuid);
                    })
                    console.log(array.toString());
                    $.ajax({
                        type: 'post',
                        url: '/b0001/deleteChecksData?random='+Math.random(),
                        data: {
                            'uuids':array.toString()
                        },
                        success: function (response) {
                            if (response.code!=0){
                                layer.alert("系统异常")
                            } else {
                                active.reload();
                            }
                        }
                    })
                }
            }
        }
        $('.layui-btn').on('click',function () {
            var type=$(this).data('type');
            /*alert(type);*/
            active[type]?active[type].call(this):'';
        })
    })
    })
</script>
</body>
</html>